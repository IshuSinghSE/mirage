name: Flatpak Multi-Arch

on:
  pull_request:
    paths:
      - 'flatpak/**'
  push:
    branches: [ main, testing ]

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        arch: [x86_64, aarch64]
    runs-on: ubuntu-latest
    env:
      MANIFEST: flatpak/io.github.IshuSinghSE.aurynk.yml
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Enable QEMU for aarch64
        if: matrix.arch == 'aarch64'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/arm64

      - name: Install Flatpak tooling
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder jq
          flatpak --version
          flatpak-builder --version

      - name: Add Flathub remote
        run: |
          sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

      - name: Cache GNOME Platform & SDK
        id: cache-flatpak-sdk
        uses: actions/cache@v4
        with:
          path: /var/lib/flatpak
          key: flatpak-gnome48-${{ matrix.arch }}-v1
          restore-keys: |
            flatpak-gnome48-${{ matrix.arch }}-

      - name: Install GNOME Platform & SDK 48
        if: steps.cache-flatpak-sdk.outputs.cache-hit != 'true'
        run: |
          sudo flatpak install -y flathub org.gnome.Platform/${{ matrix.arch }}/48 org.gnome.Sdk/${{ matrix.arch }}/48

      - name: Cache shared-modules
        id: cache-shared-modules
        uses: actions/cache@v4
        with:
          path: flatpak/shared-modules
          key: shared-modules-${{ hashFiles('.git/modules/flatpak/shared-modules/HEAD') }}
          restore-keys: |
            shared-modules-

      - name: Clone shared-modules (local build include)
        if: steps.cache-shared-modules.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 https://github.com/flathub/shared-modules.git flatpak/shared-modules

      - name: Cache flatpak-builder downloads
        uses: actions/cache@v4
        with:
          path: .flatpak-builder/downloads
          key: flatpak-downloads-${{ hashFiles('flatpak/io.github.IshuSinghSE.aurynk.yml', 'flatpak/python-dependencies.json') }}
          restore-keys: |
            flatpak-downloads-

      - name: Download-only validation
        run: |
          flatpak-builder --force-clean --arch=${{ matrix.arch }} --download-only build-dir "$MANIFEST"

      - name: Full build
        run: |
          flatpak-builder --force-clean --arch=${{ matrix.arch }} build-dir "$MANIFEST"

      - name: Smoke test (import aurynk)
        run: |
          flatpak-builder --run --arch=${{ matrix.arch }} build-dir "$MANIFEST" python3 -c "import aurynk; print('import aurynk OK')"

      - name: Export repo artifact
        run: |
          flatpak-builder --repo=repo --force-clean --arch=${{ matrix.arch }} build-dir "$MANIFEST"
          tar -czf flatpak-repo-${{ matrix.arch }}.tar.gz repo

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: flatpak-repo-${{ matrix.arch }}
          path: flatpak-repo-${{ matrix.arch }}.tar.gz
