name: Flatpak Multi-Arch

on:
  pull_request:
    paths:
      - 'flatpak/**'
  push:
    branches: [ main, testing ]

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        arch: [x86_64, aarch64]
    runs-on: ubuntu-latest
    env:
      MANIFEST: flatpak/io.github.IshuSinghSE.aurynk.yml
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Enable QEMU for aarch64
        if: matrix.arch == 'aarch64'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/arm64

      - name: Install Flatpak tooling
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder jq
          flatpak --version
          flatpak-builder --version

      - name: Add Flathub remote
        run: |
          sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

      - name: Install GNOME Platform & SDK 49
        run: |
          sudo flatpak install -y flathub org.gnome.Platform//49 org.gnome.Sdk//49

      - name: Clone shared-modules (local build include)
        run: |
          git clone --depth 1 https://github.com/flathub/shared-modules.git flatpak/shared-modules

      - name: Download-only validation
        run: |
          flatpak-builder --force-clean --arch=${{ matrix.arch }} --download-only build-dir "$MANIFEST"

      - name: Full build
        run: |
          flatpak-builder --force-clean --arch=${{ matrix.arch }} build-dir "$MANIFEST"

      - name: Smoke test (import aurynk)
        run: |
          flatpak-builder --run --arch=${{ matrix.arch }} build-dir "$MANIFEST" python3 -c "import aurynk; print('import aurynk OK')"

      - name: Export repo artifact
        run: |
          flatpak-builder --repo=repo --force-clean --arch=${{ matrix.arch }} build-dir "$MANIFEST"
          tar -czf flatpak-repo-${{ matrix.arch }}.tar.gz repo

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: flatpak-repo-${{ matrix.arch }}
          path: flatpak-repo-${{ matrix.arch }}.tar.gz
