name: Flathub build (test)
run-name: build-${{ inputs.app_id }}-${{ inputs.flat_manager_repo }}-${{ inputs.git_ref }}

concurrency:
  group: build-${{ inputs.app_id }}-${{ inputs.flat_manager_repo }}-${{ inputs.git_ref }}
  cancel-in-progress: true

on:
  push:
    branches: [ main, testing ]
  workflow_dispatch:
    inputs:
      app_id:
        description: 'Application ID (e.g. io.github.IshuSinghSE.aurynk)'
        required: true
        default: 'io.github.IshuSinghSE.aurynk'
      git_ref:
        description: 'Git reference (e.g. refs/heads/testing)'
        required: true
        default: 'refs/heads/testing'
      flat_manager_repo:
        description: 'Flat-manager repository (stable/testing)'
        required: true
        default: 'stable'
      flat_manager_token:
        description: 'Repository token (dummy for local test)'
        required: true
      build_url:
        description: 'Build ID URL placeholder'
        required: true
        default: 'test-build-id'
      callback_url:
        description: 'Callback URL (use https://example.invalid for test)'
        required: true
        default: 'https://example.invalid'
      callback_token:
        description: 'Callback token (dummy for test)'
        required: true
        default: 'dummy-token'
      build_type:
        description: 'Build type (default or spot)'
        required: true
        default: 'default'
      spot:
        description: 'Use spot instances'
        required: false
        default: 'true'

jobs:
  include-original:
    name: Copy upstream workflow logic
    runs-on: ubuntu-latest
    steps:
      - name: Show notice
        run: echo 'This workflow is a trimmed adaptation for testing. Upstream heavy jobs omitted.'

  # Minimal sanity build using flatpak-builder (no docker orchestration) to validate manifest
  build-flatpak:
    needs: include-original
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.git_ref }}
      - name: Install Flatpak tooling
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder jq
          flatpak --version
      - name: Add GNOME remote (if needed)
        run: |
          sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo || true
      - name: Build manifest
        run: |
          set -euo pipefail
          echo 'Building manifest for ${{ inputs.app_id }} @ ${{ inputs.git_ref }}'
          flatpak-builder --force-clean build-dir flatpak/io.github.IshuSinghSE.aurynk.yml --disable-rofiles-fuse
      - name: Summarize result
        run: |
          test -f build-dir/files/share/applications/io.github.IshuSinghSE.aurynk.desktop
          echo 'Build completed successfully.'
