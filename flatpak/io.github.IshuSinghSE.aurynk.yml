app-id: io.github.IshuSinghSE.aurynk
runtime: org.gnome.Platform
runtime-version: '48'
sdk: org.gnome.Sdk
command: aurynk

finish-args:
  # Set scrcpy server path
  - --env=SCRCPY_SERVER_PATH=/app/share/scrcpy/scrcpy-server
  # Set GI typelib path for AyatanaAppIndicator
  - --env=GI_TYPELIB_PATH=/app/lib/girepository-1.0
  # X11 + XShm access
  - --share=ipc
  - --socket=fallback-x11
  # Wayland access
  - --socket=wayland
  # Network access for ADB wireless
  - --share=network
  # D-Bus access for notifications and system tray
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.kde.StatusNotifierWatcher
  - --talk-name=org.ayatana.indicator.service
  # USB device access for ADB
  - --device=all

cleanup:
  - /include
  - /lib/pkgconfig
  - /man
  - /share/doc
  - /share/gtk-doc
  - /share/man
  - /share/pkgconfig
  - '*.la'
  - '*.a'

modules:
  - name: python3-meson-python-pycairo
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} meson-python pyproject-metadata
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/28/58/66db620a8a7ccb32633de9f403fe49f1b63c68ca94e5c340ec5cceeb9821/meson_python-0.18.0-py3-none-any.whl
        sha256: 3b0fe051551cc238f5febb873247c0949cd60ded556efa130aa57021804868e2
      - type: file
        url: https://files.pythonhosted.org/packages/7e/b1/8e63033b259e0a4e40dd1ec4a9fee17718016845048b43a36ec67d62e6fe/pyproject_metadata-0.9.1-py3-none-any.whl
        sha256: ee5efde548c3ed9b75a354fc319d5afd25e9585fa918a34f62f904cc731973ad

  - name: python3-poetry-core
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} poetry-core
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/c7/d8/bb2f602f5e012e177e1c8560125f9770945d36622595990cf1cb794477c2/poetry_core-2.2.1-py3-none-any.whl
        sha256: bdfce710edc10bfcf9ab35041605c480829be4ab23f5bc01202cfe5db8f125ab

  - python-dependencies.json

  - name: libusb
    buildsystem: autotools
    config-opts:
      - --prefix=/app
      - --disable-static
    sources:
      - type: archive
        url: https://github.com/libusb/libusb/releases/download/v1.0.26/libusb-1.0.26.tar.bz2
        sha256: 12ce7a61fc9854d1d2a1ffe095f7b5fac19ddba095c259e6067a46500381b5a5

  - name: adb
    buildsystem: simple
    only-arches:
      - x86_64
    build-commands:
      - install -D adb /app/bin/adb
    sources:
      - type: archive
        url: https://dl.google.com/android/repository/platform-tools_r34.0.5-linux.zip
        sha256: 362f8f6218af0f4c61e5aaafb8e255a426c7a0ee00127dfab7371775081d3124

  # Use local fixed AppIndicator module (ayatana-ido without pkgconfig cleanup)
  - modules/libayatana-appindicator-gtk3-fixed.json

  # Main application
  - name: aurynk
    buildsystem: meson
    post-install:
      # Conditionally install scrcpy: real binary on x86_64, stub on other arches (temporary until source build added)
      - |
        TARGET_ARCH="${FLATPAK_ARCH:-$(uname -m)}"
        if [ "$TARGET_ARCH" = "x86_64" ]; then
          install -Dm755 ../vendor/scrcpy/scrcpy "${FLATPAK_DEST}/bin/scrcpy"
          install -Dm644 ../vendor/scrcpy/scrcpy-server "${FLATPAK_DEST}/share/scrcpy/scrcpy-server"
        else
          mkdir -p "${FLATPAK_DEST}/bin" "${FLATPAK_DEST}/share/scrcpy"
          # Create stub scrcpy script with embedded architecture string
          cat > "${FLATPAK_DEST}/bin/scrcpy" <<'SCRCPY_STUB'
        #!/usr/bin/env bash
        echo "scrcpy is not available for architecture ${TARGET_ARCH} in this build."
        echo "Feature disabled; waiting for future multi-arch scrcpy source build integration."
        exit 1
        SCRCPY_STUB
          # Provide an empty placeholder scrcpy-server file so env var path resolves
          : > "${FLATPAK_DEST}/share/scrcpy/scrcpy-server"
          chmod +x "${FLATPAK_DEST}/bin/scrcpy"
        fi
    sources:
      - type: archive
        url: https://github.com/IshuSinghSE/aurynk/releases/download/v1.0.2/aurynk-1.0.2.tar.gz
        sha256: f18a656757d37fdf12431de46b3a731ee77fbf2abb18694ca79d692f9d13ec72