app-id: io.github.IshuSinghSE.aurynk
runtime: org.gnome.Platform
runtime-version: '49'
sdk: org.gnome.Sdk
command: aurynk

finish-args:
  # Set scrcpy server path
  - --env=SCRCPY_SERVER_PATH=/app/share/scrcpy/scrcpy-server
  # X11 + XShm access
  - --share=ipc
  - --socket=fallback-x11
  # Wayland access
  - --socket=wayland
  # Network access for ADB wireless
  - --share=network
  # D-Bus access for notifications and system tray
  - --talk-name=org.kde.StatusNotifierWatcher
  - --talk-name=org.ayatana.indicator.service
  # USB device access for ADB
  - --device=all

cleanup:
  - /include
  - /lib/pkgconfig
  - /man
  - /share/doc
  - /share/gtk-doc
  - /share/man
  - /share/pkgconfig
  - '*.la'
  - '*.a'

modules:
  - name: python3-meson-python-pycairo
    buildsystem: simple
    cleanup:
      - "*"
    build-commands:
      - pip3 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} meson-python pyproject-metadata
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/28/58/66db620a8a7ccb32633de9f403fe49f1b63c68ca94e5c340ec5cceeb9821/meson_python-0.18.0-py3-none-any.whl
        sha256: 3b0fe051551cc238f5febb873247c0949cd60ded556efa130aa57021804868e2
      - type: file
        url: https://files.pythonhosted.org/packages/7e/b1/8e63033b259e0a4e40dd1ec4a9fee17718016845048b43a36ec67d62e6fe/pyproject_metadata-0.9.1-py3-none-any.whl
        sha256: ee5efde548c3ed9b75a354fc319d5afd25e9585fa918a34f62f904cc731973ad

  - name: python3-poetry-core
    buildsystem: simple
    cleanup:
      - "*"
    build-commands:
      - pip3 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} poetry-core
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/c7/d8/bb2f602f5e012e177e1c8560125f9770945d36622595990cf1cb794477c2/poetry_core-2.2.1-py3-none-any.whl
        sha256: bdfce710edc10bfcf9ab35041605c480829be4ab23f5bc01202cfe5db8f125ab

  - python-dependencies.json

  - name: intltool
    buildsystem: autotools
    cleanup:
      - "*"
    sources:
      - type: archive
        url: https://launchpad.net/intltool/trunk/0.51.0/+download/intltool-0.51.0.tar.gz
        sha256: 67c74d94196b153b774ab9f89b2fa6c6ba79352407037c8c14d5aeb334e959cd
      - type: patch
        path: patches/intltool-perl5.26-regex-fixes.patch

  - name: adb
    buildsystem: simple
    build-commands:
      - install -D adb /app/bin/adb
    sources:
      - type: archive
        url: https://dl.google.com/android/repository/platform-tools_r34.0.5-linux.zip
        sha256: 362f8f6218af0f4c61e5aaafb8e255a426c7a0ee00127dfab7371775081d3124

  # Build Ayatana stack manually since CI clone skips submodules
  - name: libdbusmenu
    buildsystem: autotools
    build-options:
      cflags: -Wno-error
    cleanup:
      - "*.la"
      - /include
      - /lib/pkgconfig
      - /libexec
      - /share/doc
      - /share/gtk-doc
    config-opts:
      - --with-gtk=3
      - --disable-dumper
      - --disable-static
      - --disable-tests
      - --disable-gtk-doc
      - --enable-introspection=no
      - --disable-vala
    sources:
      - type: archive
        url: https://launchpad.net/libdbusmenu/16.04/16.04.0/+download/libdbusmenu-16.04.0.tar.gz
        sha256: b9cc4a2acd74509435892823607d966d424bd9ad5d0b00938f27240a1bfa878a
      - type: patch
        path: patches/libdbusmenu-0001-Fix-HAVE_VALGRIND-AM_CONDITIONAL.patch

  - name: ayatana-ido
    buildsystem: cmake-ninja
    cleanup:
      - /include
      - /lib/pkgconfig
    config-opts:
      - -DENABLE_INTROSPECTION=OFF
    sources:
      - type: git
        url: https://github.com/AyatanaIndicators/ayatana-ido.git
        tag: "0.10.4"
        commit: f968079b09e2310fefc3fc307359025f1c74b3eb
      - type: patch
        path: patches/ayatana-ido-0001-Make-introspection-configurable.patch

  - name: libayatana-indicator
    buildsystem: cmake-ninja
    cleanup:
      - /include
      - /lib/pkgconfig
      - /libexec
      - /share
    config-opts:
      - -DWITH_GTK3=ON
      - -DWITH_GTK2=OFF
      - -DWITH_DOCS=OFF
    sources:
      - type: git
        url: https://github.com/AyatanaIndicators/libayatana-indicator.git
        tag: "0.9.4"
        commit: 611bb384b73fa6311777ba4c41381a06f5b99dad

  - name: libayatana-appindicator
    buildsystem: cmake-ninja
    cleanup:
      - /include
      - /lib/pkgconfig
    config-opts:
      - -DWITH_GTK3=ON
      - -DWITH_GTK2=OFF
      - -DWITH_DOCS=OFF
      - -DENABLE_BINDINGS_MONO=NO
      - -DENABLE_BINDINGS_VALA=NO
      - -DENABLE_GTKDOC=NO
    sources:
      - type: git
        url: https://github.com/AyatanaIndicators/libayatana-appindicator.git
        tag: "0.5.94"
        commit: 31e8bb083b307e1cc96af4874a94707727bd1e79

  # scrcpy - use pre-built binary on x86_64
  - name: scrcpy
    buildsystem: simple
    build-commands:
      - install -Dm755 scrcpy /app/bin/scrcpy
      - install -Dm644 scrcpy-server /app/share/scrcpy/scrcpy-server
    sources:
      - type: archive
        url: https://github.com/Genymobile/scrcpy/releases/download/v3.3.3/scrcpy-linux-x86_64-v3.3.3.tar.gz
        sha256: 9b30e813e8191329ba8025dc80cb0f198fb0a318960a3b5c15395cf675c9c638
        strip-components: 1

  # scrcpy - build from source on non-x86_64
  - name: scrcpy-source
    buildsystem: meson
    config-opts:
      - -Dprebuilt_server=scrcpy-server
      - -Dcompile_server=false
      - -Db_lto=true
      - -Dbuildtype=release
    sources:
      - type: archive
        url: https://github.com/Genymobile/scrcpy/archive/refs/tags/v3.3.3.tar.gz
        sha256: 87fcd360a6bb6ca070ffd217bd33b33fb808b0a1572b464da51dde3fd3f6f60e
      - type: file
        url: https://github.com/Genymobile/scrcpy/releases/download/v3.3.3/scrcpy-server-v3.3.3
        sha256: 7e70323ba7f259649dd4acce97ac4fefbae8102b2c6d91e2e7be613fd5354be0
        dest-filename: scrcpy-server

  # Build the local project directly
  - name: aurynk
    buildsystem: meson
    sources:
      - type: dir
        path: ../